<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MixAchievements</title>

    <style>
        body {
            margin: 0;
            overflow: hidden;
            height: 100vh;
            width: 100%;
            display: flex;
            flex-direction: column;
            user-select: none;
        }
        
        .item {
            margin: 24px;
        }
        
        input {
            width: 100%;
            height: 28px;
        }
        
        select {
            width: 200px;
        }
        
        .title {
            font-size: 24px;
            font-weight: 800;
            background: yellow;
        }
        
        .nft-image {
            width: 300px;
            height: 300px;
            margin: 8px;
            cursor: pointer;
        }
        
        .tp-dfwv {
            width: 320px !important;
        }
        
        #pane-for-multiple {
            display: none;
            width: 100%;
            height: 100vh;
            background-color: #eee;
            position: fixed;
            top: 0;
            left: 0;
            user-select: none;
        }
        
        #pane-for-multiple .close-btn {
            position: absolute;
    bottom: 22px;
    right: 50%;
    color: black;
    background: #eee;
    outline: 1px solid white;
    line-height: 48px;
        }
        
        #pane-for-multiple #add-btn {
            position: absolute;
            bottom: 22px;
            right: 40%;
        }
        
        .btn {
            width: 44px;
            height: 44px;
            background: black;
            color: white;
            text-align: center;
            line-height: 44px;
            cursor: pointer;
        }
        
        .tags {
            display: none;
            flex-wrap: wrap;
            flex-direction: column;
        }
        
        .tag {
            background-color: aliceblue;
            line-height: 24px;
            font-size: 18px;
            padding: 6px;
            margin: 8px;
            width: fit-content;
            text-align: center;
            cursor: pointer;
        }
        
        .template-svg{
            outline: 1px solid #eee;
            margin: 24px;
            background-color: #fff;
        }
        .template-svg-img {
            width: 200px;
            height: 200px;
            cursor: pointer;
        }
        .template-svg h4{
            margin: 8px;
        }
        
        #new-item {
            display: none;
            width: 100%;
            height: 100vh;
            background: #eee;
            z-index: 99;
            position: fixed;
            padding-left: 20%;
            padding-top: 200px;
            flex-direction: column;
        }
        
        #new-item input {
            margin: 12px;
            width: 200px;
        }
        
        .selected {
            background-color: aquamarine;
        }
        
        #jsoneditor {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            background-color: #eee;
            width: 50% !important;
            height: 80vh !important;
        }

        header{
            background-color: black;
            color: white;
            display: flex;
            justify-content: start;
            align-items: center;
        }
        
        header .logo {
           
            width: 100%;
            height: 10vh;
            padding: 16px;
            display: flex;
            justify-content: start;
            align-items: center;
        }
        header #setup{
            height: 32px;
    width: 32px;
    line-height: 0;
    border: none;
    outline: none;
    margin-right: 12px;
    background: black;
    color: #00bcd4;
        }
        header .info{
            font-size: 12px;
        }
        header h4,p{
            margin: 0;
        }
        #mix-description{
            margin-right: 44px;
            margin-left: 12px;
        }
        
        main {
            width: 100%;
            min-height: 80vh;
            text-align: center;
            display: flex;
            justify-content: flex-start;
            /* align-items: center; */
            background-color: black;
        }
        
        #result {
            width: 60%;
            min-width: 500px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #nft-result:hover {
            box-shadow: 0 0 4px 0px wheat;
        }
        
        #nft-result-320 {
            width: 220px;
            height: 220px;
            display: none;
        }
        
        footer {
            height: 10vh;
            padding: 16px;
            background-color: black;
            text-align: right;
        }
        
        footer a {
            text-decoration: none;
            font-size: 12px;
            color: gray;
            font-weight: 300;
        }
        
        footer a:hover {
            color: wheat;
        }

        /* #setup-modal{
            width: 100%;
            height: 100vh;
            position: absolute;
            background: black;
            top:0;
            left:0;
        } */
        #setup-pane{
            display: none;
            width: 500px;
            /* display: flex; */
    justify-content: center;
    align-items: center;
        }
        #tool-pane{
            width:320px;
        }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsoneditor@9.9.0/dist/jsoneditor.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jsoneditor@9.9.0/dist/jsoneditor.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/svg.js/3.1.1/svg.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/randomcolor@0.6.2/randomColor.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tweakpane@3.1.0/dist/tweakpane.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tweakpane-image-plugin@1.1.3/dist/tweakpane-image-plugin.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@pangenerator/tweakpane-textarea-plugin@1.0.4/dist/tweakpane-textarea-plugin.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/object-hash@3.0.0/dist/object_hash.min.js"></script>
</head>

<body id="pasteImg">

    <header>
       
       <div class="logo">
        <div id="mix-description">

        </div>
        <div class="info">
            <div>[ MixAchievements ]</MixAchievements></div>
            <div>< 帮助DAO成员积累声望 ></div>
        </div>

       </div>
        <div class="right">
            <button id="setup"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-grid-3x3-gap-fill" viewBox="0 0 16 16">
                <path d="M1 2a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V2zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V2zM1 7a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V7zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V7zM1 12a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1v-2zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1v-2zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1v-2z"/>
              </svg></button>
        </div>
    </header>
    <main>
        <div id="result"></div>
        <div id="tool-pane"></div>
        
    </main>
    <footer><a href="https://github.com/shadowcz007">contact /  shadow</a></footer>



    <div class="item" style="display:none">
        <label for="tokenIds">合约下的tokenIds查询</label>

        <select name="tokenIds" id="tokenIds">
        </select>
        <p>检查有哪些id已经发了</p>
        <div id="tokenIds-result"></div>
    </div>
    <div class="item" style="display:none">
        <p>查询钱包地址下的nft资产</p>
        <input type="text" name="getAddressBalances" id="getAddressBalances">

        <div id="getAddressBalances-result"></div>
    </div>


    <div id="pane-for-multiple">
        <div class="tags"></div>

        <div id="jsoneditor" style="width: 100%; height:100vh;"></div>

        <div id="setup-pane"></div>
        
        <div class="close-btn btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-square-fill" viewBox="0 0 16 16">
            <path d="M2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2zm3.354 4.646L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 1 1 .708-.708z"/>
          </svg></div>
    </div>

    <div class="" style="display:none">
        <div class="item">
            <label for="creators">创作者: </label>
            <!-- <input type="text" name="creators" id="creators" required> -->

            <select name="creators" id="creators" multiple="multiple">
          
          </select>


        </div>
        <div class="item">
            <label for="sponsors">赞助方 </label>
            <!-- <input type="sponsors" name="sponsors" id="sponsors" required> -->

            <select name="sponsors" id="sponsors" multiple="multiple">
       
          </select>

        </div>
        <div class="item">
            <label for="proposal">提案</label>

            <select name="proposal" id="proposal"></select>
            <!-- <input type="proposal" name="proposal" id="proposal" autocomplete> -->
        </div>
        <div class="item">
            <label for="skills">技能</label>

            <select name="skills" id="skills" multiple="multiple">
               
              </select>

            <!-- <input type="skills" name="skills" id="skills" required> -->
        </div>
        <div class="item">
            <label for="certifications">认证</label>
            <!-- <input type="certifications" name="certifications" id="certifications" required> -->

            <select name="certifications" id="certifications" multiple="multiple">
         
            </select>


        </div>
        <div class="item">
            <label for="technicalSupports">技术</label>
            <!-- <input type="technicalSupports" name="technicalSupports" id="technicalSupports" required> -->

            <select name="technicalSupports" id="technicalSupports" multiple="multiple">
              
              </select>


        </div>
        <div class="item">
            <label for="description">描述</label>
            <input type="description" name="description" id="description" required autocomplete>
        </div>
        <div class="item">
            <label for="name">名称  ，可以很具体</label>
            <input type="name" name="name" id="name" required autocomplete>
        </div>


        <div class="item">
            <label for="fileData">源文件</label>
            <input type="file" name="fileData-input" id="fileData-input" />
            <input type="text" name="fileData" id="fileData" />
            <img src="" id="fileData-preview" style="width:200px" />
        </div>



        <div class="item">
            <label for="filetype">文件类型</label>
            <input type="filetype" name="filetype" id="filetype" required>
        </div>
        <div class="item">
            <label for="achievements" class="title">用户成就 </label>
            <!-- <input type="achievement" name="achievement" id="achievement" required> -->
            <select name="achievements" id="achievements">
               
              </select>
        </div>
        <div class="item">
            <label for="image">封面  – 预览图 - 尺寸建议320x320,640x320，推荐使用ipfs链接</label>
            <input type="file" name="image-input" id="image-input" required>
            <input type="text" name="image" id="image">
            <img src="" id="image-preview" style="width:200px" />
        </div>
        <div class="item">
            <label for="aspectRatio">宽高比</label>
            <!-- <input type="s" name="s" id="s" required> -->

            <select name="aspectRatio" id="aspectRatio">
                <option value ="1">1 正方形</option>
                <option value ="2">2 banner</option>
              </select>

        </div>


        <!-- <div class="item">
            <button onclick="getForm()">Subscribe</button>
        </div> -->
    </div>




    <!-- <button id="export">导出</button> -->
    <script>
        window.PARAMS = {
            description: '',
            name: '',
            image: '',
            nft_2048:'',
            nft_320:'',
            // 模版图片
            template: '',
            // 素材图片
            upload: '',
            result: "{}",
            init:false
        };
        // window.RESULT={};


        let pane = initPanePlugin('tool-pane');
        let setupPane=initPanePlugin('setup-pane');


        function initPanePlugin(id='tool-pane') {
            let p = new Tweakpane.Pane({
                container: document.querySelector('#'+id)
            });
            p.registerPlugin(TweakpaneImagePlugin);
            p.registerPlugin(TweakpaneTextareaPlugin);
            return p
        }

        const menuItems = {
            "creators": "创作者",
            "sponsors": "赞助方",
            "proposal": "提案",
            "skills": "技能",
            "certifications": "认证",
            "technicalSupports": "技术",
            "achievements": "用户成就",
            "description": "描述",
            "name": "名称",
            "fileData": "源文件",
            "filetype": "文件类型",
            "image": "封面",
            "aspectRatio": "宽高比"
        }

        const templates = [{
            type:'url',
            data:'01.svg'
        }, {
            type:'url',
            data:'02.svg'
        }, {
            type:'url',
            data:'03.svg'
        },...loadTemplateSvgs()].filter(f=>f);
        window.templateSvgIndex = 0;

        // 模态框
        const multiplePane = {
            init: () => {
                document.querySelector('#pane-for-multiple .close-btn').addEventListener('click', e => {
                    multiplePane.hidden();
                    multiplePane.displaySetup('none');
                });
            },
            show: () => {
                let div = document.querySelector('#pane-for-multiple');
                div.style.display = 'flex';
            },
            hidden: () => document.querySelector('#pane-for-multiple').style.display = 'none',
            showTags: () => document.querySelector('#pane-for-multiple .tags').style.display = 'flex',
            hiddenTags: () => document.querySelector('#pane-for-multiple .tags').style.display = 'none',
            displayJson: (d) => document.querySelector('#jsoneditor').style.display = d,
            displayIPFSUrl:url=>{
                document.querySelector('#pane-for-multiple .tags').innerText=url;
            },
            displaySetup:(d)=>document.querySelector('#setup-pane').style.display = d
        }

        multiplePane.init();


        const updateResult = (id, val) => {
            let res = JSON.parse(window.PARAMS.result);
            
            if(id=='name'||id=='description'){
               if(id=='name') {
                    window.PARAMS.name=val;
                    res.name=window.PARAMS.name;
                };
                if(id=='description') {
                    window.PARAMS.description=val;
                    res.description=window.PARAMS.description;
                };
               
              
                // pane.refresh();
            }else if(id=='fileData'||id=='image'){
                let data=JSON.parse(val);
                res={...res,...data};
                // res.fileData=data.fileData;
                // res.filetype=data.filetype
                // image,aspectRatio
            }else{
                res[id] = JSON.parse(val);
                delete res[id].selected;
                delete res[id].id;
            }
            
            // 填充name 和description的默认值
            if(id==='achievements'){
                window.PARAMS.description=res[id].text;
                res.description=window.PARAMS.description;
               
                window.PARAMS.name=res[id].name;
                res.name=window.PARAMS.name;
              
                pane.refresh();
            }

            window.PARAMS.result = JSON.stringify(res, null, 2);
            // console.log(id,res[id])
            //  更新了赞助方需要更新图片
            if (id === 'sponsors') {
                getResult('none');
                let data = editor.get();
                let base64 = img2base64(window.PARAMS.upload, window.PARAMS.upload.naturalWidth, window.PARAMS.upload.naturalHeight, 'png');
                createNFT(base64, data)
            };
            
        }


        const contracts_default = {
                "MixDAO徽章": "cfx:acd8xca66vh5cdd7rdfpxjkys5muj6yksabk8nfjvm",
                "MixDAO通行证": "cfx:acd0sf2e5xyzx3as5etbu7710fzubk034pn3hfapy7"

            }
            // https://confluxscan.net/token/cfx:acd0sf2e5xyzx3as5etbu7710fzubk034pn3hfapy7

        let tokenIdsHtml = '';
        for (const key in contracts_default) {
            tokenIdsHtml += `<option value="${contracts_default[key]}" >合约：${key}</option>`

        };
        document.querySelector('#tokenIds').innerHTML = tokenIdsHtml;
        document.querySelector('#tokenIds').addEventListener('change', async e => {
            getTokenIds(e.target.value).then(res => {
                res.list = Array.from(res.list, t => t.tokenId)
                document.querySelector('#tokenIds-result').innerText = JSON.stringify(res, null, 2)
            })
        })
        async function getTokenIds(d) {
            let res = await fetch(`https://api.confluxscan.net/nft/tokens?contract=${d}`);
            res = await res.json()
            return res.data
        }

        document.querySelector('#getAddressBalances').addEventListener('change', e => {
            getAddressBalances(e.target.value).then(res => {

                document.querySelector('#getAddressBalances-result').innerText = JSON.stringify(res, null, 2)
            })
        })

        async function getAddressBalances(address) {
            let res = await fetch(`https://api.confluxscan.net/nft/balances?limit=10000&owner=${address}`);
            res = await res.json()

            return res.data
        }

        document.querySelector('#setup').addEventListener('click',e=>{
            multiplePane.show();
            multiplePane.displaySetup('flex');
        })

        // 
        function fetchFromIpfs(hashId){
            // let hashId=getParams('id');
            let url='';
            if(hashId) url='https://ipfs.io/ipfs/'+hashId;
            return url
        }

        // 从ipfs获取配置文件
        // TODO 超时处理
        function initConfig() {
            let hashId=getParams('id');
            let url='config.json';
            if(hashId) url=fetchFromIpfs(hashId);
            return new Promise((res, rej) => {
                fetch(url).then(res => res.json()).then(json => {
                    // 模版分离
                    if(json.template){
                        window.PARAMS.templateSvg=json.template;
                        delete json.template;
                    }
                    // 默认的配置文件,供导出
                    window._json = {...json };
                    res(json);
                });
            })
        };

        // 处理配置文件
        function parseConfig(json) {
            // window._json={...json};
            let nJson = {...json
            };
            nJson.skills = Array.from(nJson.skills.filter(f => f), a => {
                return {
                    name: a.trim(),
                    selected: Math.random() > 0.8
                }
            });
            nJson.proposal = Array.from(nJson.proposal, p => {
                return {
                    name: p
                }
            });
            return nJson
        };


        function initPane(config) {

            initNFTConfig(pane, config);

            // const tab = pane.addTab({
            //     pages: [{
            //         title: '徽章制作'
            //     },
            //     //  {
            //     //     title: '自定义'
            //     // }, 
            //     // {
            //     //     title: '海报生成'
            //     // }
            // ],
            // });

            initSetup(setupPane, config);
            // initPoster(tab.pages[2]);
        }

        function initNFTConfig(page, config) {

            page.addInput(window.PARAMS, 'upload', {
                view: 'input-image',
                imageFit: 'contain',
                label: '徽章图片'
                    // extensions: '.svg',
            }).on('change', async e => {
                // console.log(e.value)
                if (e.presetKey === 'upload' && e.value.naturalWidth) {
                    // console.log(e.value.naturalWidth,e.value.naturalHeight)

                    getResult('none');
                    let data = editor.get();
                    let base64 = img2base64(e.value, e.value.naturalWidth, e.value.naturalHeight, 'png');
                    createNFT(base64, data)
                        // 更新预览
                        // window.PARAMS.upload = new Image();
                        // window.PARAMS.upload.src = base64;

                }
            });

            createOptions(page, config.achievements, 'achievements');

            page.addInput(window.PARAMS, 'name', {
                view: 'textarea',
                label: '名称',
                lineCount: 6,
                placeholder: '输入成就',
            }).on('change', e => {
                // getResult('none');
                // let data = editor.get();
                // let base64 = img2base64(window.PARAMS.upload, window.PARAMS.upload.naturalWidth, window.PARAMS.upload.naturalHeight, 'png');
                // createNFT(base64, data)
                // console.log(e)
                updateResult('name',e.value);

            })
            page.addInput(window.PARAMS, 'description', {
                view: 'textarea',
                label: '描述',
                lineCount: 6,
                placeholder: '输入详细描述'
            }).on('change', e => {
                updateResult('description',e.value);
            });


            createOptions(page, config.creators, 'creators', true);

            page.addSeparator();
            const f2 = page.addFolder({
                title: '结果',
            });
            f2.addButton({
                title: '生成',
                label: '徽章',
            }).on('click', e => {
                window.PARAMS.init=true;
                // 更新图片
                getResult('none');
                let data = editor.get();
                let base64 = img2base64(window.PARAMS.upload, window.PARAMS.upload.naturalWidth, window.PARAMS.upload.naturalHeight, 'png');
                createNFT(base64, data);
            });

            f2.addMonitor(window.PARAMS, 'nft_2048', {
                multiline: true,
                lineCount: 2,
                label:'fileData/源文件'
            });
            f2.addMonitor(window.PARAMS, 'image', {
                multiline: true,
                lineCount: 2,
                label:'封面'
            });

            f2.addButton({
                title: '拷贝',
                label: '元数据',
            }).on('click', e => {
                getResult('block', 'metadata')
            })

            f2.addButton({
                title: '导出zip包',
                label: '导出',
            }).on('click', e => {
                getResult()
            })



        }


        function initSetup(page, config) {

            const f1 = page.addFolder({
                title: '配置',
            });
            const f2 = page.addFolder({
                title: '徽章模版',
            });


            f1.addButton({
                title: '打开',
                label: '导入配置'
            }).on('click', e => {
                let input = document.createElement('input');
                input.type = 'file';
                input.click();
                input.addEventListener('change', e => {
                    // console.log(e.path[0].files)
                    let files = e.path[0].files;
                    if (files.length) {
                        let file = files[0];
                        let reader = new FileReader();
                        reader.onload = function() {

                            //更新配置
                            pane.dispose();
                            setupPane.dispose();
                            // 更新    
                            pane = initPanePlugin('tool-pane');
                            setupPane=initPanePlugin('setup-pane');
                            
                            let json=JSON.parse(this.result);
                            json.template=window.PARAMS.templateSvg;
                            uploadJsonFile(json,`config_${json.description}_${json.version}`).then(res=>{
                                console.log(res.data.Hash)
                                updateLocationUrl({
                                    id:res.data.Hash
                                });
                            })
                            createPane(json,true);
                        };
                        reader.readAsText(file);
                    }
                })
            });

            f1.addButton({
                title: '导出',
                label: '参考文件'
            }).on('click', e => {
                // console.log(window._json)
                let url = str2URL(JSON.stringify(window._json, null, 2), 'application/json');
                downloadFile(url, window._json.description + "_" + window._json.version + '.json')
            });
            f1.addSeparator();
            createOptions(f1, config.certifications, 'certifications')
            createOptions(f1, config.proposal, 'proposal')
            createOptions(f1, config.sponsors, 'sponsors', true)
            createOptions(f1, config.technicalSupports, 'technicalSupports', true);
            createOptions(f1, config.skills, 'skills', true);


            f2.addButton({
                title: '打开',
                label: '导入模版'
            }).on('click', e => {
                let input = document.createElement('input');
                input.type = 'file';
                input.click();
                input.addEventListener('change', e => {
                    // console.log(e.path[0].files)
                    let files = e.path[0].files;
                    if (files.length) {
                        let file = files[0];
                        let reader = new FileReader();
                        reader.onload = function() {
                            //TODO 缓存到本地
                            saveTemplateSvg(this.result);
                            window.PARAMS.templateSvg = this.result;

                            let json=getConfigFromLocal();
                            json.template=window.PARAMS.templateSvg;

                            uploadJsonFile(json,`config_${json.description}_${json.version}`).then(res=>{
                                console.log(res.data.Hash)
                                updateLocationUrl({
                                    id:res.data.Hash
                                });
                            })

                            // uploadSvgFile(window.PARAMS.templateSvg,'nft-template').then(res=>{
                            //     console.log(res.data.Hash)
                            //     updateLocationUrl({
                            //         template:res.data.Hash
                            //     });
                            // })
                            loadSvg(window.PARAMS.templateSvg)
                        };
                        reader.readAsText(file);
                    }
                })
            });

            f2.addButton({
                title: '导出',
                label: '参考文件'
            }).on('click', e => {
                // console.log(window._json)
                let url = str2URL(window.PARAMS.templateSvg, 'image/svg+xml');
                let svg = parseSvg(window.PARAMS.templateSvg);
                let title = svg.findOne('title');
                if (title) title = title.node.innerHTML.trim();
                downloadFile(url, (title || 'template') + '.svg')
            });

            f2.addInput(window.PARAMS, 'template', {
                view: 'input-image',
                imageFit: 'contain',
                label: '预览'
                    // extensions: '.svg',
            });

            f2.addButton({
                title: '更多',
                label: '选择'
            }).on('click', async e => {
                multiplePane.show();
                multiplePane.showTags();
                // 
                let tags = document.querySelector('#pane-for-multiple .tags');
                tags.innerHTML = '';
                for (let index = 0; index < templates.length; index++) {
                    console.log(index)
                    let svg=await loadSvgByType(templates[index]);
                    if(svg){

                        let card=document.createElement('div');
                        card.className='template-svg';
                        let title=extractTitleFromSvg(svg);
                        let titleDiv=document.createElement('h4');
                        titleDiv.innerText=title;
                        let im = await svg2img(svg, 'template-svg-img');
                        card.appendChild(im);
                        card.appendChild(titleDiv);

                        tags.appendChild(card);
                        im.addEventListener('click',async e => {
                            window.templateSvgIndex = index;
                            window.PARAMS.templateSvg=await loadSvgByType(templates[window.templateSvgIndex]);
                        
                                loadSvg(window.PARAMS.templateSvg);
                                // 更新图片
                                getResult('none');
                                let res = editor.get();
                                let base64 = img2base64(window.PARAMS.upload, window.PARAMS.upload.naturalWidth, window.PARAMS.upload.naturalHeight, 'png');
                                createNFT(base64, res)
                        
                            multiplePane.hidden();
                        })
                    }
                    
                }

                // Array.from(document.querySelectorAll('#pane-for-multiple .tag'), t => {
                //     t.addEventListener('click', e => {
                //         t.classList.toggle('selected');
                //         let tags = Array.from(document.querySelectorAll('#pane-for-multiple .tag'), t => {
                //             if (t.classList.contains('selected')) {
                //                 let json = JSON.parse(t.getAttribute('value'));
                //                 delete json.id;
                //                 delete json.selected;
                //                 return json
                //             }
                //         }).filter(t => t);
                //         updateResult(id, JSON.stringify(tags));
                //     })
                // })

            });

        }

       
        // 更新地址
        function updateLocationUrl(params={}){
           
            window.location.href=window.location.protocol+'//'+window.location.host+'?id='+(params.id||getParams('id'));
        }
     

        function initPoster(page) {
            fetch('nft-event.svg').then(res => res.text()).then(text => {
                // console.log(text)
                window._nftPosterSvg = text;
                // window._p=text;
                let svg = parseSvg(text);
                console.log(svg)
                    // 'qrcode','img','talk-01','talk-02','host-01','time',''
                    // if (svg) {
                    // // url 是生成好 的徽章
                    //     svg = addImg(svg, document.querySelector('#nft-result').src);
                    //     svg2base64(svg.svg(), 'nft').then(base64 => {
                    //                         let im = new Image();
                    //                         im.className = 'nft-image'
                    //                         im.src = base64;
                    //                         document.querySelector('#result').innerHTML = '';
                    //                         document.querySelector('#result').appendChild(im);
                    //                         // window._im=im;
                    // })
                    // }
            });

        }

        // 加载
        initConfig().then(async config => {
            createColors();

            // 模版
            let templateObj=templates[window.templateSvgIndex];

            // 加载ipfs的模版
            if(window.PARAMS.templateSvg){
                templateObj.data=window.PARAMS.templateSvg;
                templateObj.type='string';
            }
            // 默认的模板
            window.PARAMS.templateSvg= await loadSvgByType(templateObj)
            loadSvg(window.PARAMS.templateSvg)
            createPane(config);
        });


        // 从本地缓存读取配置文件
        function getConfigFromLocal(){
            let config;
            let d=localStorage.getItem('db_config');
            try {
                if(d) config=JSON.parse(d);
            } catch (error) {
                    
            }

            return config
        }

        // 创建gui面板
        // 增加缓存
        function createPane(config,isNew=false) {
            
            if(isNew){
                localStorage.setItem('db_config',JSON.stringify(config));
            }else{
                config=getConfigFromLocal();
            }
            console.log(config.description)
            // dao组织信息
            document.querySelector('#mix-description').innerHTML=`
            <h4>${config.description}</h4><p>${config.version}</p>`;
            config = parseConfig(config);

            initPane(config);

        }


        function createMultipleOptions(id, objs) {
            let html = '';

            for (const s of objs) {
                let n = {...s
                };
                delete n.selected;
                html += `<div class="tag ${s.selected?'selected':''}" value='${JSON.stringify(n)}'>${s.name.trim()}</div>`;
            };

            // 
            document.querySelector('#pane-for-multiple .tags').innerHTML = html;

            Array.from(document.querySelectorAll('#pane-for-multiple .tag'), t => {
                t.addEventListener('click', e => {
                    t.classList.toggle('selected');
                    let tags = Array.from(document.querySelectorAll('#pane-for-multiple .tag'), t => {
                        if (t.classList.contains('selected')) {
                            let json = JSON.parse(t.getAttribute('value'));
                            delete json.id;
                            delete json.selected;
                            return json
                        }
                    }).filter(t => t);
                    updateResult(id, JSON.stringify(tags));
                })
            })

        }


        function createOptions(page, objs, id, multiple = false) {

            let options = [];
            let selectedValues = [];
            // JSON.stringify({...objs[0],id});
            // if(id==='skills'||id==="proposal") selectedValue=objs[0].name.trim();
            for (const obj of objs) {
                // 注入id
                obj.id = id;

                if (obj.selected) {
                    // delete obj.selected;
                    selectedValues.push(obj);
                };

                let val = JSON.stringify(obj);

                options.push({
                    value: val,
                    text: obj.name
                })
            };

            if (selectedValues.length == 0) selectedValues.push(objs[0])
                // console.log(options,id,selectedValue)
            window.PARAMS[menuItems[id]] = JSON.stringify(selectedValues[0]);

            if (multiple) {
                window.PARAMS[menuItems[id]] = objs;

                updateResult(id, JSON.stringify(selectedValues));

                page.addButton({
                    title: '选择',
                    label: menuItems[id], // optional
                    // value:'333'
                }).on('click', e => {

                    multiplePane.show();
                    multiplePane.showTags();
                    multiplePane.displayJson('none');


                    let label = e.target.label;
                    // console.log(JSON.parse(window.PARAMS.result)[id],window.PARAMS[label]);

                    let list = [],
                        selected = JSON.parse(window.PARAMS.result)[id];

                    for (const u of window.PARAMS[label]) {
                        u.selected = false;
                        for (const s of selected) {
                            if (u.name == s.name) u.selected = true;
                        };
                        list.push(u)
                    }

                    createMultipleOptions(id, list)
                })

            } else {

                updateResult(id, JSON.stringify(selectedValues[0]));

                page.addBlade({
                    view: 'list',
                    label: menuItems[id],
                    options,
                    value: JSON.stringify(selectedValues[0]),
                }).on('change', e => {
                    updateResult(id, e.value);
                    // console.log(e)
                });
            }

        }


        // 随机颜色
        function createColors(n = 10) {
            window._colors = []
                // const pane = new Tweakpane.Pane();
            let colorsMap = {};
            Array.from(new Array(10), a => {
                let c = randomColor();
                colorsMap[c] = c;
                // pane.addInput(colorsMap, c);
                window._colors.push(c)
            });
            // pane.on('change', (e) => {
            //     console.log('changed: ' + JSON.stringify(e.value));
            // });
        }

        // 复制到剪切板
        function copy(value) {
            let transfer = document.createElement('input');
            document.body.appendChild(transfer);
            transfer.value = value; // 这里表示想要复制的内容
            transfer.focus();
            transfer.select();
            if (document.execCommand('copy')) {
                document.execCommand('copy');
            }
            transfer.blur();
            console.log('复制成功');
            alert('已复制到剪切板')
            document.body.removeChild(transfer);
        }



        // create the editor
        const container = document.getElementById("jsoneditor")
        const options = {}
        let editor = new JSONEditor(container, options)

        document.querySelector('#fileData-input').addEventListener('change', async e => {
            let file = e.target.files[0];

            document.querySelector('#filetype').value = file.type;
            // document.querySelector('#name').value = file.name.split('.')[0];
            let res = await uploadFileData();
            console.log(file.type, file, res)
            document.querySelector('#fileData').value = res.data.fileUrl;
            if (file.type.match('image')) {
                document.querySelector('#fileData-preview').src = res.data.fileUrl

            }
        });
        document.querySelector('#image-input').addEventListener('change', async e => {
            let file = e.target.files[0];
            console.log(file.type, file)
            if (file.type.match('image')) {
                let res = await uploadImage();
                console.log(file.type, file, res)
                document.querySelector('#image').value = res.data.fileUrl;
                document.querySelector('#image-preview').src = res.data.fileUrl;
                document.querySelector('#image-preview').onload = () => {
                    document.querySelector('#aspectRatio').value = document.querySelector('#image-preview').naturalWidth / document.querySelector('#image-preview').naturalHeight
                }

            }
            // document.querySelector('#filetype').value=file.type;
            // document.querySelector('#name').value=file.name.split('.')[0];

        });

        // document.querySelector('#export').addEventListener('click', e => {
        //     window.res = editor.get();
        //     console.log(window.res)
        // })




        function getResult(display = 'block', type) {

            let json = {
                creators: [],
                sponsors: [],
                proposal: {},
                skills: [],
                certifications: {},
                technicalSupports: [],
                image: '',
                fileData: '',
                filetype: '',
                aspectRatio: 1,
                achievements: '',
                // contract: '',
                description: window.PARAMS.description,
                name: window.PARAMS.name,
                ...JSON.parse(window.PARAMS.result)
            };
            for (const k of['creators', 'sponsors', 'technicalSupports']) {
                json[k] = Array.from(json[k], c => {
                    delete c.id;
                    delete c.selected;
                    return c
                });
            }

            json.skills = Array.from(json.skills, s => s.name ? s.name : null).filter(f => f);
            json.proposal = json.proposal.name;


            editor.set(json)
                // console.log(JSON.stringify(editor.get()))
            if (display !== 'none' && type != 'metadata' && json.name && document.querySelector('#nft-result') && document.querySelector('#nft-result-320')) {

                exportResult(
                    json.name,
                    JSON.stringify(json),
                    document.querySelector('#nft-result').src.replace('data:image/png;base64,', ''),
                    document.querySelector('#nft-result-320').src.replace('data:image/png;base64,', '')
                );


            }
            if (type == 'metadata') {
                copy(JSON.stringify(json));
                multiplePane.show();
                multiplePane.hiddenTags();
                // multiplePane.displayJson(display);
                multiplePane.displayJson('none');
                // TODO ipfs上传
                uploadJsonFile(json,'metadata').then(res=>{
                    multiplePane.showTags();
                    multiplePane.displayIPFSUrl(res.data.fileUrl)
                })
            }


        }



        // 合约地址 https://testnet.confluxscan.net/token/cfxtest:ace2w11u4g65jajzefbx2hf1yk2nesk8fu6fa4wxzn
        // 确定哪些空投了
        //post http://114.116.93.253:8097/ipfsUpload

        async function uploadFileData() {
            return await uploadFile(document.getElementById("fileData-input").files[0])
        }
        async function uploadImage(base64,fileName='image') {
            // var blob = base64toBlob(base64);
            var file = base64toFile(base64,fileName);
            return await uploadFile(file)
        }

        function uploadSvgFile(text,fileName){
            return new Promise((res,rej)=>{
                const file = new File([text], fileName+".svg", {
                    type: 'image/svg+xml;charset=utf-8',
            });
                uploadFile(file).then(result=>{
                    res(result)
                })
            })
        }

        function uploadJsonFile(json,fileName){
            return new Promise((res,rej)=>{
                const file = new File([JSON.stringify(json)], fileName+".json", {
                    type: "application/Json",
            });
                uploadFile(file).then(result=>{
                    res(result)
                })
            })
        }
        async function uploadFile(file) {

            if (!file.size) {
                alert("请选择上传文件")
                return false;
            }

            const formData = new FormData();
            formData.append("file", file);
            const url = "http://69.235.172.107:8097/ipfsUpload";
            const res = await fetch(url, {
                method: "POST",
                body: formData //自动修改请求头,formdata的默认请求头的格式是 multipart/form-data
            });

            let data=await res.json();
            // 文件类型
            data.data.type=file.type;

            return data;

        }


        function base64toFile(dataurl,fileName='image') {
            var arr = dataurl.split(','),
                mime = arr[0].match(/:(.*?);/)[1],
                bstr = window.atob(arr[1]),
                n = bstr.length,
                u8arr = new Uint8Array(n);
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new File([u8arr], fileName+'.'+mime.replace(/.*\//ig,''),{
                type: mime
            });
        }
        //将blob转换为file
        // function blobToFile(theBlob, fileName) {
        //     theBlob.lastModifiedDate = new Date();
        //     theBlob.name = fileName;
        //     return theBlob;
        // }




        function str2URL(data, type) {
            // svg "image/svg+xml;charset=utf-8" 
            var blob = new Blob([data], {
                type: type
            })
            return URL.createObjectURL(blob)
        }

        function createCanvas(width, height) {
            let canvas = document.createElement('canvas')
            canvas.width = width
            canvas.height = height
            return canvas
        }

        function downloadFile(url, filename) {
            // console.log(url)
            if (!url) return
            let link = document.createElement('a')
            link.style.display = 'none'
            link.href = url
            link.setAttribute('download', filename)
                // document.body.appendChild(link) 
            link.click()
                // document.body.removeChild(link);
        }

        function svg2base64(svgStr = null, type = 'png', width = null, height = null) {
            if (!svgStr) return
            return new Promise((resolve, reject) => {
                let url = str2URL(svgStr, 'image/svg+xml;charset=utf-8')
                let img = new Image();
                img.onload = () => {
                    width = width || img.width * 2
                    height = height || img.height * 2;

                    let base64 = img2base64(img, width, height, type);
                    URL.revokeObjectURL(url)
                    resolve(base64)
                }
                img.src = url
            })
        }

        function img2base64(img, width, height, type = 'png') {
            if (!img) return
            let canvas = createCanvas(width, height)
            let ctx = canvas.getContext('2d')
            ctx.drawImage(img, 0, 0, width, height)
            let base64 = canvas.toDataURL(`image/${type}`)
            return base64
        }

        function imgResize(img, w, h, type = 'png') {
            let canvas = createCanvas(w, h)
            let ctx = canvas.getContext('2d')
            ctx.drawImage(img, 0, 0, img.naturalWidth, img.naturalHeight, 0, 0, w, h)
            let base64 = canvas.toDataURL(`image/${type}`)
            return base64
        }

        function create(text = '你好呀，欢迎及爱如 基金会 mixldao mixlab  斤斤计较') {
            if (!window.PARAMS.templateSvg) return
            return parseSvg(window.PARAMS.templateSvg, text);
        }

           //  提取标题
     function extractTitleFromSvg(text){
        let svg = parseSvg(text);
        let title = svg.findOne('title');
        if (title) title = title.node.innerHTML.trim();
        return title;
     }

    //  加载svg
      async  function loadSvgByType(data){
            let svg=data.data;
            return new Promise((res,rej)=>{
                if(data.type==='url'){
                    svg=null;

                    fetch(data.data).then(async result=>{
                        if(result.ok) {
                            svg = await result.text()
                        };
                        res(svg);
                    }).catch(error => {
                        console.error('There has been a problem with your fetch operation:', error);
                    });

                }else{
                    res(svg);
                }
            })
              
        }

        // 缓存svg
        function saveTemplateSvg(text){
            let id=objectHash(text);
            localStorage.setItem(id,text);
            let svgs=localStorage.getItem('_templateSvgs')||'[]';
            try {
                if(svgs)svgs=JSON.parse(svgs);
            } catch (error) {
                
            };
            svgs.push(id);
            localStorage.setItem('_templateSvgs',JSON.stringify(svgs));
        }

        // 加载本地缓存到svg
        function loadTemplateSvgs(){
            let svgs=localStorage.getItem('_templateSvgs')||'[]';
            try {
                if(svgs)svgs=JSON.parse(svgs);
            } catch (error) {
                
            };
            for (let index = 0; index < svgs.length; index++) {
                let text=localStorage.getItem(svgs[index]);
                if(text)  svgs[index]={
                    type:'string',
                    data:text
                }
            }

            return svgs.filter(f=>f);
        }

        // 
        function parseSvg(t, text = "") {
            let s = SVG();
            s.svg(t);
            let svg = s.children()[0];
            // console.log(text, svg.findOne('#nft-text') && text && text != "")
            if (svg.findOne('#nft-text') && text && text != "") svg.findOne('#nft-text').attr('startOffset', Math.round(Math.random() * 200)).text(text);

            if (svg.findOne('#color-stroke')) svg.findOne('#color-stroke').attr('stroke', window._colors[Math.round(Math.random() * 10)]);

            // 为了保证正常导出base64
            let ks = ['text', 'textPath', 'tspan']
            for (const k of ks) {
                Array.from(svg.find(k), t => {
                    t.dom = {};
                })
            }

            return svg
        }

        function addImg(svg, base64) {

            let im = svg.findOne('#img');
            im.svg(`<image x=\"${im.attr('x')}\" y=\"${im.attr('y')}\" width=\"${im.attr('width')}\" height=\"${im.attr('height')}\" xlink:href=\"${base64}\"></image>`)
            return svg
        }

        function blobToDataURL(blob, cb) {
            let reader = new FileReader();
            reader.onload = function(evt) {
                let base64 = evt.target.result;
                cb(base64);
            };
            reader.readAsDataURL(blob);
        };

        function textParse(text) {
            var pattern2 = new RegExp("[A-Za-z]+");

            text = Array.from(text.split(""), t => {
                return pattern2.test(t) ? t : ' ' + t + ' '
            }).join("").replace(/\s+/gi, ' ')

            return text
        }





        function pasteImg(e) {
            // console.log(e)
            if (e.clipboardData.items) {
                ele = e.clipboardData.items
                for (var i = 0; i < ele.length; ++i) {
                    if (ele[i].kind == 'file' && ele[i].type.indexOf('image/') !== -1) {
                        var blob = ele[i].getAsFile();
                        let data = editor.get();
                        // console.log(blob)
                        blobToDataURL(blob, base64 => {

                            createNFT(base64, data);
                            // 更新预览
                            window.PARAMS.upload = new Image();
                            window.PARAMS.upload.src = base64;
                            pane.refresh()
                        })
                    }

                }
            } else {
                alert('non-chrome');
            }
        }

        function createNFT(url, data) {
            // console.log(data)

            if (!url) return
                // if (!(data.name != '')) return alert('请输入名称');
            let text = data.name;
            if (data.sponsors && data.sponsors.length > 0) text = data.name + ' - ' + Array.from(data.sponsors, s => s.name).join(' & ');

            let svg = create(textParse(text));
            if (svg) {
                svg = addImg(svg, url);
                svg2base64(svg.svg(), 'nft').then(base64 => {
                    document.querySelector('#result').innerHTML = '';

                    let im = new Image();
                    im.className = 'nft-image'
                    im.id = 'nft-result';
                    im.src = base64;
                    im.onload = async() => {
                         
                        let s320 = await imgResize(im, 320, 320);
                        let im320 = new Image();
                        im320.className = 'nft-image'
                        im320.id = 'nft-result-320';
                        im320.src = s320;
                        if (document.querySelector('#result').children.length === 0) {
                            document.querySelector('#result').appendChild(im320);
                            document.querySelector('#result').appendChild(im);
                            im.addEventListener('click', e => {
                                downloadFile(base64, 'nft_2048.png')
                            })
                            im320.addEventListener('click', e => {
                                downloadFile(s320, 'nft_320.png')
                            });

                            // 当点过生成后才可以上传
                            if(window.PARAMS.init)  uploadImage(s320,im320.id+'.png').then(r320=>{
                                window.PARAMS.image=r320.data.fileUrl;
                                uploadImage(base64,im.id+'.png').then(r=>{
                                    window.PARAMS.nft_2048=r.data.fileUrl;
                                    // pane.refresh();
                                    updateResult('image',JSON.stringify({
                                        image:window.PARAMS.image,
                                        aspectRatio:1
                                    }));

                                    updateResult('fileData',JSON.stringify({
                                        fileData:window.PARAMS.nft_2048,
                                        filetype:r.data.type
                                    }));

                                })
                            })
                            
                        }

                    }

                })
            }


            // pane.refresh();

        }

        function exportResult(name, jsonStr, base64_2048, base64_320) {
            const zip = new JSZip();

            zip.file("metadata.json", jsonStr);

            const img = zip.folder("images");
            img.file("nft_2048.png", base64_2048, {
                base64: true
            });
            img.file("nft_320.png", base64_320, {
                base64: true
            });
            zip.generateAsync({
                    type: "base64"
                })
                .then(function(content) {
                    downloadFile("data:application/zip;base64," + content, name + '.zip')
                });
        }
        // svg 转 img base64
        function svg2img(tx, className = 'nft-image') {
            return new Promise((res, rej) => {
                let svg = parseSvg(tx);
                svg2base64(svg.svg(), 'png').then(base64 => {
                    let im = new Image();
                    im.className = className;
                    im.src = base64;
                    res(im)
                })
            })

        }

        function loadSvg(text) {
            return new Promise((res, rej) => {
                svg2img(text, 'nft-image').then(im => {
                    window.PARAMS.template = im;
                    pane.refresh();
                    res();
                })
            });
        }

        document.getElementById('pasteImg').onpaste = function() {
            getResult('none')
            pasteImg(event);
            return false;
        };


        // 从url获取参数
        function getParams (name) {
            var reg = new RegExp("[^\\?&]?" + name + "=[^&]+");
            var regArr = window.location.search.match(reg);
            if (regArr != null) {
                return regArr[0].substring(regArr[0].search("=") + 1);
            }
            return "";
        }

    </script>
</body>

</html>