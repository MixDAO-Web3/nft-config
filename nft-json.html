<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <style>
        body {
            /* display: flex; */
        }
        
        .item {
            margin: 24px;
        }
        
        input {
            width: 100%;
            height: 28px;
        }
        
        select {
            width: 200px;
        }
        
        .title {
            font-size: 24px;
            font-weight: 800;
            background: yellow;
        }
        
        .nft-image {
            width: 600px;
            height: 600px;
        }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsoneditor@9.9.0/dist/jsoneditor.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jsoneditor@9.9.0/dist/jsoneditor.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/svg.js/3.1.1/svg.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/randomcolor@0.6.2/randomColor.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tweakpane@3.1.0/dist/tweakpane.min.js"></script>
    <script src="http://unpkg.com/fabric/dist/fabric.min.js"></script>
</head>

<body>

    <div class="item">
        <label for="tokenIds">合约下的tokenIds查询</label>

        <select name="tokenIds" id="tokenIds">
        </select>
        <p>检查有哪些id已经发了</p>
        <div id="tokenIds-result"></div>
    </div>
    <div class="item">
        <p>查询钱包地址下的nft资产</p>
        <input type="text" name="getAddressBalances" id="getAddressBalances">

        <div id="getAddressBalances-result"></div>
    </div>

    <div class="">
        <div class="item">
            <label for="creators">创作者: </label>
            <!-- <input type="text" name="creators" id="creators" required> -->

            <select name="creators" id="creators" multiple="multiple">
          
          </select>


        </div>
        <div class="item">
            <label for="sponsors">赞助方 </label>
            <!-- <input type="sponsors" name="sponsors" id="sponsors" required> -->

            <select name="sponsors" id="sponsors" multiple="multiple">
       
          </select>

        </div>
        <div class="item">
            <label for="proposal">提案</label>
            <select name="proposal" id="proposal"></select>
            <!-- <input type="proposal" name="proposal" id="proposal" autocomplete> -->
        </div>
        <div class="item">
            <label for="skills">技能</label>

            <select name="skills" id="skills" multiple="multiple">
               
              </select>

            <!-- <input type="skills" name="skills" id="skills" required> -->
        </div>
        <div class="item">
            <label for="certifications">认证</label>
            <!-- <input type="certifications" name="certifications" id="certifications" required> -->

            <select name="certifications" id="certifications" multiple="multiple">
         
            </select>


        </div>
        <div class="item">
            <label for="technicalSupports">技术</label>
            <!-- <input type="technicalSupports" name="technicalSupports" id="technicalSupports" required> -->

            <select name="technicalSupports" id="technicalSupports" multiple="multiple">
              
              </select>


        </div>
        <div class="item">
            <label for="description">描述</label>
            <input type="description" name="description" id="description" required autocomplete>
        </div>
        <div class="item">
            <label for="name">名称  ，可以很具体</label>
            <input type="name" name="name" id="name" required autocomplete>
        </div>


        <div id="editable" contenteditable="true">
            <p>这是一个可编辑的div区域</p>
            <p>将图像粘贴到这里。</p>
        </div>


        <div class="item">
            <label for="fileData">源文件</label>
            <input type="file" name="fileData-input" id="fileData-input" />
            <input type="text" name="fileData" id="fileData" />
            <img src="" id="fileData-preview" style="width:200px" />
        </div>
        <div class="item">
            <label for="filetype">文件类型</label>
            <input type="filetype" name="filetype" id="filetype" required>
        </div>
        <div class="item">
            <label for="achievements" class="title">用户成就 </label>
            <!-- <input type="achievement" name="achievement" id="achievement" required> -->
            <select name="achievements" id="achievements">
               
              </select>
        </div>
        <div class="item">
            <label for="image">封面  – 预览图 - 尺寸建议320x320,640x320，推荐使用ipfs链接</label>
            <input type="file" name="image-input" id="image-input" required>
            <input type="text" name="image" id="image">
            <img src="" id="image-preview" style="width:200px" />
        </div>
        <div class="item">
            <label for="aspectRatio">宽高比</label>
            <!-- <input type="s" name="s" id="s" required> -->

            <select name="aspectRatio" id="aspectRatio">
                <option value ="1">1 正方形</option>
                <option value ="2">2 banner</option>
              </select>


        </div>


        <div class="item">
            <button onclick="getForm()">Subscribe</button>
        </div>
    </div>


    <div id="jsoneditor" style="width: 400px; height: 400px;"></div>

    <button id="export">导出</button>
    <script>
        const contracts_default = {
                "MixDAO徽章": "cfx:acd8xca66vh5cdd7rdfpxjkys5muj6yksabk8nfjvm",
                "MixDAO通行证": "cfx:acd0sf2e5xyzx3as5etbu7710fzubk034pn3hfapy7"

            }
            // https://confluxscan.net/token/cfx:acd0sf2e5xyzx3as5etbu7710fzubk034pn3hfapy7

        let tokenIdsHtml = '';
        for (const key in contracts_default) {
            tokenIdsHtml += `<option value="${contracts_default[key]}" >合约：${key}</option>`

        };
        document.querySelector('#tokenIds').innerHTML = tokenIdsHtml;
        document.querySelector('#tokenIds').addEventListener('change', async e => {
            getTokenIds(e.target.value).then(res => {
                res.list = Array.from(res.list, t => t.tokenId)
                document.querySelector('#tokenIds-result').innerText = JSON.stringify(res, null, 2)
            })
        })
        async function getTokenIds(d) {
            let res = await fetch(`https://api.confluxscan.net/nft/tokens?contract=${d}`);
            res = await res.json()
            return res.data
        }

        document.querySelector('#getAddressBalances').addEventListener('change', e => {
            getAddressBalances(e.target.value).then(res => {

                document.querySelector('#getAddressBalances-result').innerText = JSON.stringify(res, null, 2)
            })
        })

        async function getAddressBalances(address) {
            let res = await fetch(`https://api.confluxscan.net/nft/balances?limit=10000&owner=${address}`);
            res = await res.json()

            return res.data
        }


        const config = {
            "creators": [{
                "name": "shadow",
                "text": "设计黑客",
                "url": "https://github.com/shadowcz007"
            }, {
                "name": "潜石",
                "text": "微信号Einstein_Lannan，欢迎来到某石的Neverland，亲爱的彼得·潘们 ( ● '◡' ● ) 这里有故事（推理，科幻，幽默...）也有社评，影评，心理专栏...... 愿助你的棱角，守护你的软肋，与这个斑斓世界，温柔共处。"
            }, {
                "name": "碳基肥柴",
                "text": "无界成员ML764，不会写代码的设计师不是好肥宅，一个游走在艺术和程序之间的人，欢迎一起奔赴未来，开启无界之旅。",
                "url": "https://www.mrthinker.top"
            }, {
                "name": "🌞",
                "text": "AI可以在瞬间颠覆人的想象力，但并不会超越，除非摆烂",
                "url": ""

            }, {
                "name": "杜韦柯",
                "text": "设计跨学科探索者，DAO组织实践者，元宇宙记者编辑",
                "url": ""
            }, {
                "name": "迷塔城MetaCity",
                "text": "迷塔城1933是以赛博科幻姿态，追求潮流打卡的文化空间；依托1933老场坊精妙结构，近10000平的电影级科幻置景。在不同的势力建筑中留下影像，在迷塔城彰显个性姿态，你就是赛博世界的主角。",
                "url": "https://mp.weixin.qq.com/s/U6WIPzgtYZR379UGBEN_ew"
            }],
            "sponsors": [{
                "name": "Mixlab无界社区",
                "url": "https://github.com/MixLabPro"
            }, {
                "name": "MixDAO",
                "url": "https://github.com/MixDAO-Web3"
            }, {
                "name": "shadow的实验室",
                "url": "https://github.com/shadowcz007"
            }, {
                "name": "迷塔城MetaCity",
                "url": "https://mp.weixin.qq.com/s/U6WIPzgtYZR379UGBEN_ew"
            }],
            "proposal": ["MixDAO通行证和徽章体系发布", "MetaCity启航数字纪念徽章"],
            "skills": Array.from(`DAO架构师
            数字艺术家
            NFT收藏家
            人工智能专家
            元宇宙创作者
            DAO成员
            虚拟空间设计师
            导演
            设计师
            潮牌店主理人
            投资人
            路人甲
            学生
            跨界人才
            无边界学习者
            AI艺术家
            算法工程师
            程序员
            设计黑客
            艺术黑客
            科幻作者
            游戏设计师
            独立开发者
            开源项目发起人
            老师
            顾问
            首席品牌官
            首席产品官
            增长黑客
            专栏作者
            `.trim().split('\n').filter(f => f), a => {
                return {
                    name: a.trim()
                }
            }),
            "certifications": [{
                "name": "MixDAO",
                "url": "https://github.com/MixDAO-Web3"
            }],
            "technicalSupports": [{
                "name": "bigan",
                "url": "http://open.flyray.me"
            }, {
                "name": "anyweb",
                "url": "https://anyweb.cc"
            }, {
                "name": "Stable diffusion",
                "url": "https://github.com/CompVis/stable-diffusion"
            }],
            "achievements": [{
                "name": "Hello MixDAO",
                "text": "今天，DAO成立啦~"
            }, {
                "name": "AI生成挑战赛",
                "text": "挑战自我，遇见更好的自己"
            }, {
                "name": "黑客马拉松",
                "text": "一起协作，尽情创造"
            }, {
                "name": "乐于分享",
                "text": "感谢你的每一次无私分享"
            }, {
                "name": "开拓者",
                "text": "感谢你的每一次扩散"
            }, {
                "name": "Mixlab创造力团队",
                "text": "每一次协作，都代表着你的成长"
            }, {
                "name": "BookDAO成立运营小组",
                "text": "成立运营小组，制定语雀共建文档，正式探索《元宇宙创意图谱》知识DAO/MixDAO运营与商业模式"
            }, {
                "name": "专栏作者",
                "text": "感谢你的系统化输出"
            }, {
                "name": "Mix嘉宾",
                "text": "分享无限，突破知识边界"
            }, {
                "name": "无边界学习者",
                "text": "致敬跨学科、不设限的持续学习者"
            }, {
                "name": "提案",
                "text": "一起见证下一个苹果和谷歌的诞生"
            }, {
                "name": "走访计划",
                "text": "零距离，挖掘商业机会"
            }, {
                "name": "激活器",
                "text": "负责想出点子的人，创新的ABCDEF模型的A"
            }, {
                "name": "虚拟空间",
                "text": "一起探索现实与虚拟的缝隙"
            }, {
                "name": "开源见证",
                "text": "一起见证开源项目的发布"
            }, {
                "name": "做客MixDAO",
                "text": "寻找当代 Crypto 达芬奇"
            }, {
                "name": "NFT通行证",
                "text": "DAO成员的凭证，开启DAO的神秘通道"
            }, {
                "name": "MetaCity启航",
                "text": "世集文旅在2022.9.13出发,带着迷塔城,带着人类对元宇宙的期待和幻想,赋予SH1933星球一个浪漫的定义"
            }]
        }





        createOptions(config.creators, 'creators')
        createOptions(config.sponsors, 'sponsors')
        createOptions(config.proposal, 'proposal')
        createOptions(config.skills, 'skills')
        createOptions(config.certifications, 'certifications')
        createOptions(config.technicalSupports, 'technicalSupports')
        createOptions(config.achievements, 'achievements')




        function createOptions(objs, id) {

            for (const obj of objs) {
                let option = document.createElement('option');
                option.value = typeof(obj) != 'string' ? JSON.stringify(obj) : obj;
                option.innerText = obj.name || obj;
                document.querySelector('#' + id).appendChild(option)
            }

        }




        // create the editor
        const container = document.getElementById("jsoneditor")
        const options = {}
        let editor = new JSONEditor(container, options)

        document.querySelector('#fileData-input').addEventListener('change', async e => {
            let file = e.target.files[0];

            document.querySelector('#filetype').value = file.type;
            document.querySelector('#name').value = file.name.split('.')[0];
            let res = await uploadFileData();
            console.log(file.type, file, res)
            document.querySelector('#fileData').value = res.data.fileUrl;
            if (file.type.match('image')) {
                document.querySelector('#fileData-preview').src = res.data.fileUrl

            }
        });
        document.querySelector('#image-input').addEventListener('change', async e => {
            let file = e.target.files[0];
            console.log(file.type, file)
            if (file.type.match('image')) {
                let res = await uploadImage();
                console.log(file.type, file, res)
                document.querySelector('#image').value = res.data.fileUrl;
                document.querySelector('#image-preview').src = res.data.fileUrl;
                document.querySelector('#image-preview').onload = () => {
                    document.querySelector('#aspectRatio').value = document.querySelector('#image-preview').naturalWidth / document.querySelector('#image-preview').naturalHeight
                }

            }
            // document.querySelector('#filetype').value=file.type;
            // document.querySelector('#name').value=file.name.split('.')[0];

        });

        document.querySelector('#export').addEventListener('click', e => {
            window.res = editor.get();
            console.log(window.res)
        })

        createSkills(config.skills);

        function getForm() {

            let json = {
                creators: [],
                sponsors: [],
                proposal: {},
                skills: [],
                certifications: [],
                technicalSupports: [],
                image: '',
                fileData: '',
                filetype: '',
                aspectRatio: 1,
                achievements: '',
                // contract: '',
                description: '',
                name: ''
            }
            for (const key in json) {
                let t = document.querySelector(`#${key}`);
                if (t) json[key] = t.value;
                if (key == 'achievements') json[key] = JSON.parse(t.value);
                if (t && t.getAttribute('multiple') === 'multiple') {
                    json[key] = [];
                    for (const option of t.querySelectorAll('option')) {
                        if (option.selected == true) {
                            json[key].push(['certifications', 'creators', 'sponsors', 'technicalSupports'].includes(key) ? JSON.parse(option.value) : option.value);
                        }
                    }
                }
                if (key === 'aspectRatio') json[key] = parseFloat(json[key])
            }

            form2json(json)
        }

        function createSkills(skills) {
            let html = '';

            for (const s of skills) {
                html += `<option value="${s.name.trim()}">${s.name.trim()}</option>`;
            }
            document.querySelector('#skills').innerHTML = html;
        }

        function form2json(json) {


            // set json
            // const initialJson = {
            //     "Array": [1, 2, 3],
            //     "Boolean": true,
            //     "Null": null,
            //     "Number": 123,
            //     "Object": {"a": "b", "c": "d"},
            //     "String": "Hello World"
            // }
            editor.set(json)
            console.log(JSON.stringify(editor.get()))
        }

        // 合约地址 https://testnet.confluxscan.net/token/cfxtest:ace2w11u4g65jajzefbx2hf1yk2nesk8fu6fa4wxzn
        // 确定哪些空投了
        //post http://114.116.93.253:8097/ipfsUpload

        async function uploadFileData() {
            return await upload(document.getElementById("fileData-input"))
        }
        async function uploadImage() {
            return await upload(document.getElementById("image-input"))
        }
        async function upload(ip) {

            if (ip.files.length === 0) {
                alert("请选择上传文件")
                return false;
            }

            const formData = new FormData();
            formData.append("file", ip.files[0]);
            const url = "http://114.116.93.253:8097/ipfsUpload";
            const res = await fetch(url, {
                method: "POST",
                body: formData //自动修改请求头,formdata的默认请求头的格式是 multipart/form-data
            })

            return await res.json();

        }

        function str2URL(data, type) {
            // svg "image/svg+xml;charset=utf-8"
            var blob = new Blob([data], {
                type: type
            })
            return URL.createObjectURL(blob)
        }

        function createCanvas(width, height) {
            let canvas = document.createElement('canvas')
            canvas.width = width
            canvas.height = height
            return canvas
        }

        function downloadFile(url, filename) {
            console.log(url)
            if (!url) return
            let link = document.createElement('a')
            link.style.display = 'none'
            link.href = url
            link.setAttribute('download', filename)
                // document.body.appendChild(link) 
            link.click()
                // document.body.removeChild(link);
        }

        function svg2base64(svgStr = null, type = 'png', width = null, height = null) {
            if (!svgStr) return
            return new Promise((resolve, reject) => {
                let url = str2URL(svgStr, 'image/svg+xml;charset=utf-8')
                let img = new Image();
                img.onload = () => {
                    width = width || img.width * 2
                    height = height || img.height * 2
                    let canvas = createCanvas(width, height)
                    let ctx = canvas.getContext('2d')
                    ctx.drawImage(img, 0, 0, width, height)
                    let base64 = canvas.toDataURL(`image/${type}`)
                    URL.revokeObjectURL(url)
                    resolve(base64)
                }
                img.src = url
            })
        }

        function create(text = '你好呀，欢迎及爱如 基金会 mixldao mixlab  斤斤计较') {
            return fetch('01.svg').then(r => r.text()).then(t => {
                let s = SVG();
                s.svg(t);
                let svg = s.children()[0];
                svg.findOne('#font').attr('startOffset', Math.round(Math.random() * 200)).text(text);
                svg.findOne('#board-02').attr('stroke', window._colors[Math.round(Math.random() * 10)])
                svg.findOne('text').dom = {};
                svg.findOne('textPath').dom = {};
                svg.findOne('tspan').dom = {};
                // svg2base64(svg.svg()).then(url => downloadFile(url));
                //document.body.appendChild(s.children()[0].node)
                return svg
            })
        }

        function addImg(svg, base64) {

            let im = svg.findOne('#img');
            im.svg(`<image x=\"${im.attr('x')}\" y=\"${im.attr('y')}\" width=\"${im.attr('width')}\" height=\"${im.attr('height')}\" xlink:href=\"${base64}\"></image>`)
            return svg
        }

        function blobToDataURL(blob, cb) {
            let reader = new FileReader();
            reader.onload = function(evt) {
                let base64 = evt.target.result;
                cb(base64);
            };
            reader.readAsDataURL(blob);
        };

        function textParse(text) {
            var pattern2 = new RegExp("[A-Za-z]+");

            text = Array.from(text.split(""), t => {
                return pattern2.test(t) ? t : ' ' + t + ' '
            }).join("").replace(/\s+/gi, ' ')

            return text
        }

        function pasteImg(e) {
            // console.log(e)
            if (e.clipboardData.items) {
                ele = e.clipboardData.items
                for (var i = 0; i < ele.length; ++i) {
                    if (ele[i].kind == 'file' && ele[i].type.indexOf('image/') !== -1) {
                        var blob = ele[i].getAsFile();
                        let data = editor.get();
                        blobToDataURL(blob, base64 => {
                            create(
                                textParse(data.name + ' - ' + Array.from(data.sponsors, s => s.name).join(' & '))
                            ).then(svg => {
                                svg = addImg(svg, base64);

                                svg2base64(svg.svg(), 'nft').then(base64 => {
                                    let im = new Image();
                                    im.className = 'nft-image'
                                    im.src = base64;
                                    document.body.appendChild(im);
                                })
                            })
                        })

                    }

                }
            } else {
                alert('non-chrome');
            }
        }

        document.getElementById('editable').onpaste = function() {
            getForm()
            pasteImg(event);
            return false;
        };
        createColors()

        function createColors(n = 10) {
            window._colors = []
            const pane = new Tweakpane.Pane();
            let colorsMap = {};
            Array.from(new Array(10), a => {
                let c = randomColor();
                colorsMap[c] = c;
                pane.addInput(colorsMap, c);
                window._colors.push(c)
            });
            pane.on('change', (e) => {
                console.log('changed: ' + JSON.stringify(e.value));
            });
        }
    </script>
</body>

</html>