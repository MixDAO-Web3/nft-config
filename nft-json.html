<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <style>
        body {
            /* display: flex; */
        }
        
        .item {
            margin: 24px;
        }
        
        input {
            width: 100%;
            height: 28px;
        }
        
        select {
            width: 200px;
        }
        
        .title {
            font-size: 24px;
            font-weight: 800;
            background: yellow;
        }
        
        .nft-image {
            width: 400px;
            height: 400px;
        }

        .tp-dfwv { width: 320px !important;}

        #pane-for-multiple{
            display: none;
            width: 100%;
            height: 100vh;
            background-color: #eee;
            position: fixed;
            top:0;
            left: 0;
            user-select: none;
        }
        #pane-for-multiple .close-btn{
            position: absolute;
            width: 44px;
            height: 44px;
            background: black;
            color: white;
            text-align: center;
            line-height: 44px;
            bottom: 22px;
            right: 50%;
            cursor: pointer;
        }
        .tags{
            display: none;
            flex-wrap: wrap;
            flex-direction: column;
        }
        .tag{
            background-color: aliceblue;
            line-height: 24px;
            font-size: 18px;
            padding: 4px;
            margin: 8px;
            text-align: center;
            cursor: pointer;
        }
        .selected{
            background-color: aquamarine;
        }

        #jsoneditor{
            display: none;
            position: fixed;
            top:0;
            left: 0;
            background-color: #eee;
            width: 50% !important;
            height: 80vh !important;
        }
        #editable{
            background-color: aquamarine;
            width: 200px;
            height: 200px;
            padding: 12px;
        }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsoneditor@9.9.0/dist/jsoneditor.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jsoneditor@9.9.0/dist/jsoneditor.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/svg.js/3.1.1/svg.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/randomcolor@0.6.2/randomColor.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tweakpane@3.1.0/dist/tweakpane.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tweakpane-image-plugin@1.1.3/dist/tweakpane-image-plugin.min.js"></script>
    
</head>

<body>

    <div class="item" style="display:none">
        <label for="tokenIds">合约下的tokenIds查询</label>

        <select name="tokenIds" id="tokenIds">
        </select>
        <p>检查有哪些id已经发了</p>
        <div id="tokenIds-result"></div>
    </div>
    <div class="item" style="display:none">
        <p>查询钱包地址下的nft资产</p>
        <input type="text" name="getAddressBalances" id="getAddressBalances">

        <div id="getAddressBalances-result"></div>
    </div>


    <div id="pane-for-multiple"> 
        <div class="tags"></div>
        <div id="jsoneditor" style="width: 100%; height:100vh;"></div>
        <div class="close-btn">X</div>
    </div>

    

    <div id="editable" contenteditable="false">
       <p>将图像粘贴到这里。</p>
    </div>

    <div id="result"></div>

    <div class="" style="display:none">
        <div class="item">
            <label for="creators">创作者: </label>
            <!-- <input type="text" name="creators" id="creators" required> -->

            <select name="creators" id="creators" multiple="multiple">
          
          </select>

          
        </div>
        <div class="item">
            <label for="sponsors">赞助方 </label>
            <!-- <input type="sponsors" name="sponsors" id="sponsors" required> -->
           
            <select name="sponsors" id="sponsors" multiple="multiple">
       
          </select>

        </div>
        <div class="item">
            <label for="proposal">提案</label>
            
            <select name="proposal" id="proposal"></select>
            <!-- <input type="proposal" name="proposal" id="proposal" autocomplete> -->
        </div>
        <div class="item">
            <label for="skills">技能</label>
            
            <select name="skills" id="skills" multiple="multiple">
               
              </select>

            <!-- <input type="skills" name="skills" id="skills" required> -->
        </div>
        <div class="item">
            <label for="certifications">认证</label>
            <!-- <input type="certifications" name="certifications" id="certifications" required> -->
            
            <select name="certifications" id="certifications" multiple="multiple">
         
            </select>


        </div>
        <div class="item">
            <label for="technicalSupports">技术</label>
            <!-- <input type="technicalSupports" name="technicalSupports" id="technicalSupports" required> -->
            
            <select name="technicalSupports" id="technicalSupports" multiple="multiple">
              
              </select>


        </div>
        <div class="item">
            <label for="description">描述</label>
            <input type="description" name="description" id="description" required autocomplete>
        </div>
        <div class="item">
            <label for="name">名称  ，可以很具体</label>
            <input type="name" name="name" id="name" required autocomplete>
        </div>

        
        <div class="item">
            <label for="fileData">源文件</label>
            <input type="file" name="fileData-input" id="fileData-input" />
            <input type="text" name="fileData" id="fileData" />
            <img src="" id="fileData-preview" style="width:200px" />
        </div>

       

        <div class="item">
            <label for="filetype">文件类型</label>
            <input type="filetype" name="filetype" id="filetype" required>
        </div>
        <div class="item">
            <label for="achievements" class="title">用户成就 </label>
            <!-- <input type="achievement" name="achievement" id="achievement" required> -->
            <select name="achievements" id="achievements">
               
              </select>
        </div>
        <div class="item">
            <label for="image">封面  – 预览图 - 尺寸建议320x320,640x320，推荐使用ipfs链接</label>
            <input type="file" name="image-input" id="image-input" required>
            <input type="text" name="image" id="image">
            <img src="" id="image-preview" style="width:200px" />
        </div>
        <div class="item">
            <label for="aspectRatio">宽高比</label>
            <!-- <input type="s" name="s" id="s" required> -->

            <select name="aspectRatio" id="aspectRatio">
                <option value ="1">1 正方形</option>
                <option value ="2">2 banner</option>
              </select>

        </div>


        <!-- <div class="item">
            <button onclick="getForm()">Subscribe</button>
        </div> -->
    </div>


    

    <!-- <button id="export">导出</button> -->
    <script>
        window.PARAMS={
            description:'',
            name:'',
            image:'',
            // 模版图片
            template:'',
            // 素材图片
            upload:'', 
            result:"{}"
        };
        // window.RESULT={};


        const pane = new Tweakpane.Pane();
        pane.registerPlugin(TweakpaneImagePlugin);
        

        const menuItems={
              "creators":"创作者",
              "sponsors":"赞助方",
              "proposal":"提案",
              "skills":"技能",
              "certifications":"认证",
              "technicalSupports":"技术",
              "achievements":"用户成就",
              "description":"描述",
              "name":"名称",
              "fileData":"源文件",
              "filetype":"文件类型",
              "image":"封面",
              "aspectRatio":"宽高比"
            }
        
        // 模态框
        const multiplePane={
            init:()=>{
                document.querySelector('#pane-for-multiple .close-btn').addEventListener('click',e=>{
                    multiplePane.hidden();
                })
            },
            show:()=>{
                let div=document.querySelector('#pane-for-multiple');
                div.style.display='flex';
            },
            hidden:()=>document.querySelector('#pane-for-multiple').style.display='none',
            showTags:()=>document.querySelector('#pane-for-multiple .tags').style.display='flex',
            hiddenTags:()=>document.querySelector('#pane-for-multiple .tags').style.display='none',
            displayJson:(d)=>document.querySelector('#jsoneditor').style.display=d,
        }

        multiplePane.init();


        const updateResult=(id,val)=>{
                let res=JSON.parse(window.PARAMS.result);
                res[id]=JSON.parse(val);
                delete res[id].selected;
                delete res[id].id;
                window.PARAMS.result=JSON.stringify(res,null,2)
            }


        const contracts_default = {
                "MixDAO徽章": "cfx:acd8xca66vh5cdd7rdfpxjkys5muj6yksabk8nfjvm",
                "MixDAO通行证": "cfx:acd0sf2e5xyzx3as5etbu7710fzubk034pn3hfapy7"

            }
            // https://confluxscan.net/token/cfx:acd0sf2e5xyzx3as5etbu7710fzubk034pn3hfapy7

        let tokenIdsHtml = '';
        for (const key in contracts_default) {
            tokenIdsHtml += `<option value="${contracts_default[key]}" >合约：${key}</option>`

        };
        document.querySelector('#tokenIds').innerHTML = tokenIdsHtml;
        document.querySelector('#tokenIds').addEventListener('change', async e => {
            getTokenIds(e.target.value).then(res => {
                res.list = Array.from(res.list, t => t.tokenId)
                document.querySelector('#tokenIds-result').innerText = JSON.stringify(res, null, 2)
            })
        })
        async function getTokenIds(d) {
            let res = await fetch(`https://api.confluxscan.net/nft/tokens?contract=${d}`);
            res = await res.json()
            return res.data
        }

        document.querySelector('#getAddressBalances').addEventListener('change', e => {
            getAddressBalances(e.target.value).then(res => {

                document.querySelector('#getAddressBalances-result').innerText = JSON.stringify(res, null, 2)
            })
        })

        async function getAddressBalances(address) {
            let res = await fetch(`https://api.confluxscan.net/nft/balances?limit=10000&owner=${address}`);
            res = await res.json()

            return res.data
        }

        function initConfig(){
           return new Promise((res,rej)=>{
                fetch('config.json').then(res=>res.json()).then(json=>{
                    json.skills= Array.from(json.skills.filter(f => f), a => {
                        return {
                                name: a.trim(),
                                selected: Math.random() > 0.8
                            }
                    });
                    json.proposal=Array.from(json.proposal,p=>{
                        return {
                            name:p
                        }
                    })
                    res(json)
                });
            })
        }

        initConfig().then(config=>{
            console.log(config)
            pane.addInput(window.PARAMS, 'upload', {
                            view: 'input-image',
                            imageFit: 'contain',
                            label:'徽章图片'
                            // extensions: '.svg',
                        });

            pane.addInput(window.PARAMS, 'name',{
                label:'名称'
            });
            pane.addInput(window.PARAMS, 'description',{
                label:'描述'
            });
            
            
            pane.addButton({
                title:'打开模版'
            }).on('click',e=> {
                let input=document.createElement('input');
                input.type='file';
                input.click();
                input.addEventListener('change',e=>{
                    console.log(e.path[0].files)
                    let files=e.path[0].files;
                    if(files.length){
                        let file = files[0];
                        let reader = new FileReader();
                        reader.onload = function(){
                            window.PARAMS.templateSvg=this.result;
                            loadSvg(window.PARAMS.templateSvg)
                        };
                        reader.readAsText(file);
                    }
                })
                // loadSvg();
            })

            pane.addInput(window.PARAMS, 'template', {
                            view: 'input-image',
                            imageFit: 'contain',
                            label:'模版'
                            // extensions: '.svg',
                        });
            createOptions(config.certifications, 'certifications')
            createOptions(config.proposal, 'proposal')
            createOptions(config.achievements, 'achievements');

            createOptions(config.creators, 'creators',true)
            createOptions(config.sponsors, 'sponsors',true)
            createOptions(config.technicalSupports, 'technicalSupports',true);
            createOptions(config.skills, 'skills',true);

        
            // pane.addMonitor(window.PARAMS, 'result', {
            //         label:'元数据',
            //         multiline: true,
            //         lineCount: 12,
            //     });

            pane.addButton({
                    title: '导出',
                    label: '导出',
                }).on('click',e=>{
                    getResult()
                })

            createColors();

        });



        function createMultipleOptions(id,objs) {
            let html = '';

            for (const s of objs) {
                let n={...s};
                delete n.selected;
                html += `<div class="tag ${s.selected?'selected':''}" value='${JSON.stringify(n)}'>${s.name.trim()}</div>`;
            };
            
            document.querySelector('#pane-for-multiple .tags').innerHTML =html;
            Array.from(document.querySelectorAll('#pane-for-multiple .tag'),t=>{
                t.addEventListener('click',e=>{
                    t.classList.toggle('selected');
                    let tags=Array.from(document.querySelectorAll('#pane-for-multiple .tag'),t=>{
                        if(t.classList.contains('selected')){
                            let json=JSON.parse(t.getAttribute('value'));
                            delete json.id;
                            delete json.selected;
                            return json
                        }
                    }).filter(t=>t);
                    updateResult(id,JSON.stringify(tags));
                })
            })
            
        }


        function createOptions(objs, id,multiple=false) {

            let options=[];
            let selectedValues=[];
            // JSON.stringify({...objs[0],id});
            // if(id==='skills'||id==="proposal") selectedValue=objs[0].name.trim();
            for (const obj of objs) {
                // 注入id
                obj.id=id;

                if (obj.selected) {
                    // delete obj.selected;
                    selectedValues.push(obj);
                };
          
                let val=JSON.stringify(obj);
    
                options.push({
                    value:val,
                    text:obj.name
                })
            };

            if(selectedValues.length==0) selectedValues.push(objs[0])
            // console.log(options,id,selectedValue)
            window.PARAMS[menuItems[id]]=JSON.stringify(selectedValues[0]);
            
            if(multiple){
                window.PARAMS[menuItems[id]]=objs;

                updateResult(id,JSON.stringify(selectedValues));

                pane.addButton({
                    title: '选择',
                    label: menuItems[id],   // optional
                    // value:'333'
                }).on('click',e=>{

                    multiplePane.show();
                    multiplePane.showTags();
                    multiplePane.displayJson('none');

                    let label=e.target.label;
                    // console.log(JSON.parse(window.PARAMS.result)[id],window.PARAMS[label]);

                    let list=[],selected=JSON.parse(window.PARAMS.result)[id];

                    for (const u of window.PARAMS[label]) {
                        u.selected=false;
                        for (const s of selected) {
                            if(u.name==s.name) u.selected=true;
                        };
                        list.push(u)
                    }
                    
                    createMultipleOptions(id,list)
                })

            }else{

                updateResult(id,JSON.stringify(selectedValues[0]));

                pane.addBlade({
                    view: 'list',
                    label: menuItems[id],
                    options,
                    value: JSON.stringify(selectedValues[0]),
                }).on('change',e=>{
                    updateResult(id,e.value);
                });
            }
            
        }

        

        function createColors(n = 10) {
            window._colors = []
            // const pane = new Tweakpane.Pane();
            let colorsMap = {};
            Array.from(new Array(10), a => {
                let c = randomColor();
                colorsMap[c] = c;
                // pane.addInput(colorsMap, c);
                window._colors.push(c)
            });
            // pane.on('change', (e) => {
            //     console.log('changed: ' + JSON.stringify(e.value));
            // });
        }

        // 复制到剪切板
        function copy(value) {
            let transfer = document.createElement('input');
            document.body.appendChild(transfer);
            transfer.value =value;  // 这里表示想要复制的内容
            transfer.focus();
            transfer.select();
            if (document.execCommand('copy')) {
                document.execCommand('copy');
            }
            transfer.blur();
            console.log('复制成功');
            alert('已复制到剪切板')
            document.body.removeChild(transfer);
        }



        // create the editor
        const container = document.getElementById("jsoneditor")
        const options = {}
        let editor = new JSONEditor(container, options)

        document.querySelector('#fileData-input').addEventListener('change', async e => {
            let file = e.target.files[0];

            document.querySelector('#filetype').value = file.type;
            // document.querySelector('#name').value = file.name.split('.')[0];
            let res = await uploadFileData();
            console.log(file.type, file, res)
            document.querySelector('#fileData').value = res.data.fileUrl;
            if (file.type.match('image')) {
                document.querySelector('#fileData-preview').src = res.data.fileUrl

            }
        });
        document.querySelector('#image-input').addEventListener('change', async e => {
            let file = e.target.files[0];
            console.log(file.type, file)
            if (file.type.match('image')) {
                let res = await uploadImage();
                console.log(file.type, file, res)
                document.querySelector('#image').value = res.data.fileUrl;
                document.querySelector('#image-preview').src = res.data.fileUrl;
                document.querySelector('#image-preview').onload = () => {
                    document.querySelector('#aspectRatio').value = document.querySelector('#image-preview').naturalWidth / document.querySelector('#image-preview').naturalHeight
                }

            }
            // document.querySelector('#filetype').value=file.type;
            // document.querySelector('#name').value=file.name.split('.')[0];

        });

        // document.querySelector('#export').addEventListener('click', e => {
        //     window.res = editor.get();
        //     console.log(window.res)
        // })




        function getResult(display='block') {

            let json = {
                creators: [],
                sponsors: [],
                proposal: {},
                skills: [],
                certifications: {},
                technicalSupports: [],
                image: '',
                fileData: '',
                filetype: '',
                aspectRatio: 1,
                achievements: '',
                // contract: '',
                description: window.PARAMS.description,
                name:window.PARAMS.name,
                ...JSON.parse(window.PARAMS.result)
            };
            for (const k of ['creators','sponsors','technicalSupports']) {
                json[k]=Array.from(json[k],c=>{
                    delete c.id;
                    delete c.selected;
                    return c
                });
            }
            
            json.skills=Array.from(json.skills,s=>s.name);
            json.proposal=json.proposal.name;
            

            editor.set(json)
            console.log(JSON.stringify(editor.get()))
            copy(JSON.stringify(json))
            
            multiplePane.show();
            multiplePane.hiddenTags();
            multiplePane.displayJson(display);

            // for (const key in json) {
            //     let t = document.querySelector(`#${key}`);
            //     if (t) json[key] = t.value;
            //     if (key == 'achievements') json[key] = JSON.parse(t.value);
            //     if (t && t.getAttribute('multiple') === 'multiple') {
            //         json[key] = [];
            //         for (const option of t.querySelectorAll('option')) {
            //             if (option.selected == true) {
            //                 json[key].push(['certifications', 'creators', 'sponsors', 'technicalSupports'].includes(key) ? JSON.parse(option.value) : option.value);
            //             }
            //         }
            //     }
            //     if (key === 'aspectRatio') json[key] = parseFloat(json[key])
            // }

            // form2json(json)
        }



        function form2json(json) {


            // set json
            // const initialJson = {
            //     "Array": [1, 2, 3],
            //     "Boolean": true,
            //     "Null": null,
            //     "Number": 123,
            //     "Object": {"a": "b", "c": "d"},
            //     "String": "Hello World"
            // }
            editor.set(json)
            console.log(JSON.stringify(editor.get()))
        }

        // 合约地址 https://testnet.confluxscan.net/token/cfxtest:ace2w11u4g65jajzefbx2hf1yk2nesk8fu6fa4wxzn
        // 确定哪些空投了
        //post http://114.116.93.253:8097/ipfsUpload

        async function uploadFileData() {
            return await upload(document.getElementById("fileData-input"))
        }
        async function uploadImage() {
            return await upload(document.getElementById("image-input"))
        }
        async function upload(ip) {

            if (ip.files.length === 0) {
                alert("请选择上传文件")
                return false;
            }

            const formData = new FormData();
            formData.append("file", ip.files[0]);
            const url = "http://114.116.93.253:8097/ipfsUpload";
            const res = await fetch(url, {
                method: "POST",
                body: formData //自动修改请求头,formdata的默认请求头的格式是 multipart/form-data
            })

            return await res.json();

        }

        function str2URL(data, type) {
            // svg "image/svg+xml;charset=utf-8"
            var blob = new Blob([data], {
                type: type
            })
            return URL.createObjectURL(blob)
        }

        function createCanvas(width, height) {
            let canvas = document.createElement('canvas')
            canvas.width = width
            canvas.height = height
            return canvas
        }

        function downloadFile(url, filename) {
            console.log(url)
            if (!url) return
            let link = document.createElement('a')
            link.style.display = 'none'
            link.href = url
            link.setAttribute('download', filename)
                // document.body.appendChild(link) 
            link.click()
                // document.body.removeChild(link);
        }

        function svg2base64(svgStr = null, type = 'png', width = null, height = null) {
            if (!svgStr) return
            return new Promise((resolve, reject) => {
                let url = str2URL(svgStr, 'image/svg+xml;charset=utf-8')
                let img = new Image();
                img.onload = () => {
                    width = width || img.width * 2
                    height = height || img.height * 2
                    let canvas = createCanvas(width, height)
                    let ctx = canvas.getContext('2d')
                    ctx.drawImage(img, 0, 0, width, height)
                    let base64 = canvas.toDataURL(`image/${type}`)
                    URL.revokeObjectURL(url)
                    resolve(base64)
                }
                img.src = url
            })
        }

        function create(text = '你好呀，欢迎及爱如 基金会 mixldao mixlab  斤斤计较') {
            if(!window.PARAMS.templateSvg)return
            return parseSvg(window.PARAMS.templateSvg,text);
        }


        function parseSvg(t,text=""){
            let s = SVG();
                s.svg(t);
                let svg = s.children()[0];
                
                if(svg.findOne('#font')) svg.findOne('#font').attr('startOffset', Math.round(Math.random() * 200)).text(text);
                
                if(svg.findOne('#board-02')) svg.findOne('#board-02').attr('stroke', window._colors[Math.round(Math.random() * 10)]);
                // 为了保证正常导出base64
                for (const k of ['text','textPath','tspan']) {
                    Array.from(svg.find(k),t=>{
                        t.dom={};
                    })
                }
                // svg.findOne('text').dom = {};
                // svg.findOne('textPath').dom = {};
                // svg.findOne('tspan').dom = {};
            return svg
        }

        function addImg(svg, base64) {

            let im = svg.findOne('#img');
            im.svg(`<image x=\"${im.attr('x')}\" y=\"${im.attr('y')}\" width=\"${im.attr('width')}\" height=\"${im.attr('height')}\" xlink:href=\"${base64}\"></image>`)
            return svg
        }

        function blobToDataURL(blob, cb) {
            let reader = new FileReader();
            reader.onload = function(evt) {
                let base64 = evt.target.result;
                cb(base64);
            };
            reader.readAsDataURL(blob);
        };

        function textParse(text) {
            var pattern2 = new RegExp("[A-Za-z]+");

            text = Array.from(text.split(""), t => {
                return pattern2.test(t) ? t : ' ' + t + ' '
            }).join("").replace(/\s+/gi, ' ')

            return text
        }

        function pasteImg(e) {
            // console.log(e)
            if (e.clipboardData.items) {
                ele = e.clipboardData.items
                for (var i = 0; i < ele.length; ++i) {
                    if (ele[i].kind == 'file' && ele[i].type.indexOf('image/') !== -1) {
                        var blob = ele[i].getAsFile();
                        let data = editor.get();
                        blobToDataURL(blob, base64 => {
                            // 更新预览
                            window.PARAMS.upload=new Image();
                            window.PARAMS.upload.src=base64;
                            pane.refresh();

                            let text='';
                            if(data.sponsors) text=data.name + ' - ' + Array.from(data.sponsors, s => s.name).join(' & ');

                           let svg= create(
                                textParse(text)
                            );
                            if(svg){
                                svg = addImg(svg, base64);
                                svg2base64(svg.svg(), 'nft').then(base64 => {
                                        let im = new Image();
                                        im.className = 'nft-image'
                                        im.src = base64;
                                        document.querySelector('#result').innerHTML='';
                                        document.querySelector('#result').appendChild(im);
                                        // window._im=im;
                                })
                            } 
                            
                            
                        })

                    }

                }
            } else {
                alert('non-chrome');
            }
        }

        function loadSvg(text){
            let svg=parseSvg(text);
            // console.log(svg);
            svg2base64(svg.svg(), 'nft').then(base64 => {
                let im = new Image();
                im.className = 'nft-image'
                im.src = base64;
                window.PARAMS.template=im;
                // window.PARAMS.svg=svg;
                pane.refresh();
            })             
        }

        document.getElementById('editable').onpaste = function() {
            getResult('none')
            pasteImg(event);
            return false;
        };
        
       
    </script>
</body>

</html>